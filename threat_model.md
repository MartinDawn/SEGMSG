THREAT MODEL: SecMsg Application (v0.1)Ngày lập: 08/02/2026Phiên bản: 1.0Tác giả: Phạm Gia TríPhạm vi: Giao thức truyền tin Peer-to-Peer, Cơ chế mã hóa (AES-CTR), và Trao đổi khóa (Diffie-Hellman).1. Tổng quan hệ thống (System Overview)SecMsg là ứng dụng nhắn tin trực tiếp (P2P) giữa hai người dùng (Alice và Bob).Kiến trúc: Client-Server lai (mỗi Peer vừa là client vừa là server).Giao thức: TCP Socket.Bảo mật:Trao đổi khóa: Diffie-Hellman (DH) Group 14.Mã hóa: AES-128 chế độ CTR.Toàn vẹn: HMAC-SHA256 (Encrypt-then-MAC).Dẫn xuất khóa: HKDF.2. Sơ đồ Luồng dữ liệu (Data Flow Diagram - DFD)Chúng ta phân tích luồng dữ liệu để xác định Trust Boundaries (Ranh giới tin cậy).Đoạn mãgraph LR
    User[Người dùng Alice] -- Input (Tin nhắn) --> App_Memory[Bộ nhớ Ứng dụng]
    App_Memory -- Plaintext --> Encryption_Module[Module Mã hóa (AES+HMAC)]
    Encryption_Module -- Ciphertext Packet --> Socket[Network Socket]
    
    subgraph "Trust Boundary (Internet/LAN)"
    Socket -- Dữ liệu không an toàn --> Network[Mạng Internet/Attacker]
    end
    
    Network -- Dữ liệu không an toàn --> Socket_Bob[Socket Bob]
    Socket_Bob -- Ciphertext Packet --> Decryption_Module[Module Giải mã (AES+HMAC)]
    Decryption_Module -- Plaintext --> App_Memory_Bob[Bộ nhớ Ứng dụng Bob]
    App_Memory_Bob -- Hiển thị --> User_Bob[Người dùng Bob]
Trust Boundary: Nằm ngay tại Network Socket. Mọi dữ liệu đi ra khỏi Socket được coi là bị tổn hại. Mọi dữ liệu đi vào từ Socket là không đáng tin cậy (untrusted input).3. Phân tích đe dọa theo STRIDEDưới đây là phân tích chi tiết các mối đe dọa đối với phiên bản code hiện tại (Tháng 2).3.1. S - Spoofing Identity (Giả mạo định danh)Định nghĩa: Kẻ tấn công (Eve) giả danh là Alice để nói chuyện với Bob.Lỗ hổng trong v0.1:Giao thức sử dụng Diffie-Hellman để trao đổi khóa, nhưng không có xác thực (Authentication).Bob nhận được Public Key nhưng không biết nó đến từ Alice hay từ Eve.Kịch bản tấn công (Man-in-the-Middle):Alice gửi Pub_A. Eve chặn lại.Eve gửi Pub_Eve cho Bob.Bob nghĩ Pub_Eve là của Alice, tính ra Shared_Secret_Eve_Bob.Eve chặn tin nhắn mã hóa, giải mã bằng key giả mạo, đọc tin, rồi mã hóa lại gửi cho Bob.Đánh giá rủi ro: CRITICAL (Nghiêm trọng).Kế hoạch khắc phục (Tháng 3): Triển khai RSA Digital Signature. Alice phải ký vào Pub_A bằng Private Key của mình.3.2. T - Tampering with Data (Can thiệp dữ liệu)Định nghĩa: Eve sửa đổi nội dung gói tin trên đường truyền.Hiện trạng v0.1:Đã triển khai HMAC-SHA256 theo mô hình Encrypt-then-MAC.Nếu Eve thay đổi 1 bit của Ciphertext, Bob tính lại HMAC và thấy không khớp -> Gói tin bị hủy.Lỗ hổng tiềm ẩn:Nếu tấn công Spoofing (3.1) thành công, Eve sẽ sở hữu khóa HMAC chung với Bob. Lúc này Eve có thể sửa tin nhắn và tạo lại HMAC hợp lệ mới.Đánh giá rủi ro: MEDIUM (An toàn nếu không bị Spoofing).3.3. R - Repudiation (Chối bỏ)Định nghĩa: Alice gửi tin nhắn "Tôi nợ bạn 1 tỷ", nhưng sau đó chối "Tôi không gửi tin này, Bob tự bịa ra".Lỗ hổng trong v0.1:Sử dụng HMAC (Key đối xứng). Cả Alice và Bob đều giữ HMAC_Key.Bob hoàn toàn có thể tự tạo ra tin nhắn giả và tính HMAC hợp lệ. Do đó, Bob không thể chứng minh trước tòa là Alice đã gửi tin nhắn.Đánh giá rủi ro: HIGH.Kế hoạch khắc phục (Tháng 3): Sử dụng Chữ ký số (Digital Signature). Chỉ Alice (người giữ Private Key) mới có thể tạo ra chữ ký hợp lệ.3.4. I - Information Disclosure (Tiết lộ thông tin)Định nghĩa: Eve đọc trộm nội dung tin nhắn.Lỗ hổng trong v0.1 (LỖI NGHIÊM TRỌNG):Tái sử dụng Nonce (Nonce Reuse): Code hiện tại đang hardcode nonce = b"\x00"*8 cho mọi tin nhắn AES-CTR.Tính chất của Stream Cipher: $C = P \oplus Keystream$. Nếu Nonce và Key không đổi, Keystream không đổi.Kịch bản khai thác:Eve bắt được gói tin 1 ($C_1$) và gói tin 2 ($C_2$).Eve tính $X = C_1 \oplus C_2$.Kết quả $X$ chính là $P_1 \oplus P_2$ (XOR của hai nội dung tin nhắn).Sử dụng kỹ thuật "Crib Dragging", Eve có thể khôi phục hoàn toàn nội dung tin nhắn mà không cần biết Key.Đánh giá rủi ro: CRITICAL. Đây là lỗi triển khai sơ đẳng phá hủy hoàn toàn tính bảo mật.Kế hoạch khắc phục: Thêm trường Sequence Number vào header và dùng nó làm Nonce biến thiên.3.5. D - Denial of Service (Từ chối dịch vụ)Định nghĩa: Eve làm sập ứng dụng của Bob.Lỗ hổng trong v0.1:Ứng dụng nhận gói tin, phân tích header, tính HMAC, giải mã...Nếu Eve gửi 1 triệu gói tin rác (garbage bytes), CPU của Bob sẽ tốn tài nguyên để xử lý HMAC cho từng gói tin.Chưa có giới hạn kích thước gói tin (length trong header có thể bị làm giả thành số cực lớn gây tràn bộ nhớ).Đánh giá rủi ro: MEDIUM.3.6. E - Elevation of Privilege (Leo thang đặc quyền)Định nghĩa: Eve chiếm quyền điều khiển máy tính của Bob thông qua ứng dụng.Hiện trạng:SecMsg viết bằng Python (Memory safe), sử dụng struct để parse dữ liệu. Rủi ro buffer overflow thấp hơn C/C++.Tuy nhiên, cần đảm bảo không dùng các hàm nguy hiểm như eval() hay pickle.loads() trên dữ liệu nhận được.4. Ánh xạ tới OWASP Top 10 (2021)Mô hình đe dọa trên tương ứng trực tiếp với các mục sau trong OWASP Top 10:OWASP IDTên LỗiÁnh xạ tới SecMsgA02:2021Cryptographic FailuresLỗi Nonce Reuse trong AES-CTR (Mục 3.4). Sử dụng tham số DH yếu (nếu không dùng Group 14).A07:2021Identification & Auth FailuresThiếu xác thực danh tính khi bắt tay (Mục 3.1). Cho phép kẻ tấn công MITM.A08:2021Software & Data IntegrityNếu không kiểm tra chữ ký số, ứng dụng có thể nhận bản cập nhật giả hoặc cấu hình giả mạo.5. Kế hoạch hành động ưu tiên (Mitigation Roadmap)Dựa trên mức độ rủi ro, đây là thứ tự công việc cần làm ngay:PRIORITY 1 (Fix Critical Bug): Sửa lỗi Nonce Reuse.Hành động: Thêm biến đếm (counter) vào class Peer. Gửi kèm counter trong gói tin. Dùng counter làm IV cho AES.PRIORITY 2 (Authentication): Chống Spoofing/MITM.Hành động: Tích hợp RSA. Tạo cặp khóa Public/Private. Ký vào gói tin Handshake.PRIORITY 3 (Non-repudiation): Chống Chối bỏ.Hành động: Ký vào từng tin nhắn (hoặc dùng khóa phiên được xác thực mạnh).